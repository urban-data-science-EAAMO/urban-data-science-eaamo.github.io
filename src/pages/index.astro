---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import LinkButton from "@components/LinkButton.astro";
import Hr from "@components/Hr.astro";
import ProjectCard from "@components/ProjectCard";
import ExpandableSpeakerCard from "@components/ExpandableSpeakerCard.astro";
import Socials from "@components/Socials.astro";
import { SITE, SOCIALS } from "@config";
import { resolveDoi } from "@utils/doi";

const projects = await getCollection("projects");
const speakers = await getCollection("speakers");
const sortedSpeakers = speakers.sort((a: CollectionEntry<'speakers'>, b: CollectionEntry<'speakers'>) => b.data.eventDate.getTime() - a.data.eventDate.getTime());

// Build small view models for homepage speaker cards, with derived tags
type HomeSpeakerView = { entry: CollectionEntry<'speakers'>; displayTags: string[] };

// Get current date (without time) for comparison
const today = new Date();
today.setHours(0, 0, 0, 0);

// Filter upcoming speakers (future dates)
const upcomingSpeakers = speakers
  .filter((entry: CollectionEntry<'speakers'>) => entry.data.eventDate >= today)
  .sort((a: CollectionEntry<'speakers'>, b: CollectionEntry<'speakers'>) => a.data.eventDate.getTime() - b.data.eventDate.getTime()); // Sort ascending for upcoming

const upcomingSpeakerViews: HomeSpeakerView[] = upcomingSpeakers.map((entry: CollectionEntry<'speakers'>) => {
  const baseTags: string[] = entry.data.tags ?? [];
  const isGuest: boolean = (entry.data.affiliation ?? '').toLowerCase() === 'guest speaker';
  const hasGuestTag: boolean = baseTags.some((t: string) => t.toLowerCase() === 'guest speaker');
  const displayTags: string[] = (isGuest && !hasGuestTag) ? [...baseTags, 'guest speaker'] : baseTags;
  return { entry, displayTags } as HomeSpeakerView;
});

// Filter past speakers for "Recent Speakers & Activities"
const pastSpeakers = speakers
  .filter((entry: CollectionEntry<'speakers'>) => entry.data.eventDate < today)
  .sort((a: CollectionEntry<'speakers'>, b: CollectionEntry<'speakers'>) => b.data.eventDate.getTime() - a.data.eventDate.getTime()); // Sort descending for past

const homeSpeakerViews: HomeSpeakerView[] = pastSpeakers.slice(0, 4).map((entry: CollectionEntry<'speakers'>) => {
  const baseTags: string[] = entry.data.tags ?? [];
  const isGuest: boolean = (entry.data.affiliation ?? '').toLowerCase() === 'guest speaker';
  const hasGuestTag: boolean = baseTags.some((t: string) => t.toLowerCase() === 'guest speaker');
  const displayTags: string[] = (isGuest && !hasGuestTag) ? [...baseTags, 'guest speaker'] : baseTags;
  return { entry, displayTags } as HomeSpeakerView;
});

// Sort projects by order field
const sortedProjects = projects.sort((a: CollectionEntry<'projects'>, b: CollectionEntry<'projects'>) => 
  (a.data.order || Infinity) - (b.data.order || Infinity)
);

//

// Members collection
const members = await getCollection("members");
const sortedMembers = members.sort((a: CollectionEntry<'members'>, b: CollectionEntry<'members'>) => (a.data.order || 9999) - (b.data.order || 9999));

// Reading list (resolve DOIs; top 5)
type HomeReadingItem = { title: string; url: string; year?: number; venue?: string };
const pubs: CollectionEntry<"publications">[] = await getCollection("publications");
const pubsResolved = await Promise.all(
  pubs.map(async (e: CollectionEntry<"publications">) => {
    const meta = await resolveDoi(e.data.doi);
    return {
      title: e.data.title ?? meta?.title ?? e.data.doi,
      url: e.data.url ?? meta?.url ?? `https://doi.org/${e.data.doi}`,
      year: e.data.year ?? meta?.year,
      venue: e.data.venue ?? meta?.venue,
    } as HomeReadingItem;
  })
);
const readingItems: HomeReadingItem[] = pubsResolved
  .sort((a: HomeReadingItem, b: HomeReadingItem) => (b.year ?? 0) - (a.year ?? 0))
  .slice(0, 5);

const socialCount = SOCIALS.filter(social => social.active).length;
---

<Layout pageType="home">
  <Header />
  <main id="main-content" class="home-content px-0"> 
    <div class="left-col">
      <section id="hero">
        <h1 class="site-logo text-3xl font-bold mb-4">Urban Data Science & Equitable Cities</h1>
        {
          // only display if at least one social link is enabled
          socialCount > 0 && false && (
            <div class="social-wrapper">
              <div class="social-links"></div>
              <Socials />
            </div>
          )
        }
        <p>
          By 2050, the UN projects that 68% of the population will live in a city. With urban life shaping health and opportunity, using data to guide decisions and reduce inequality is critical. In this EAAMO Bridges working group, we host speakers, study papers, and workshop late-stage work on computational analysis of urban data, emphasizing topics that explore and address inequities in urban life.
          <br><br>

        </p>
        <p>
          We meet every other week on <b>Mondays 12-1pm EST</b> for a presentation followed by sustained discussion. Join our mailing list or contact one of the organizers for Zoom meeting information---we would be happy to see you joining!
          <br><br>

        </p>
        <div class="home-cta">
          <LinkButton className="btn-primary" href="/join/">Join Our Mailing List!</LinkButton>
          <LinkButton className="btn-primary" href=""
          <a class="btn-secondary inline-flex items-center gap-2 px-4 py-2 rounded-md border transition-all duration-200" href="https://bridges.eaamo.org/" target="_blank" rel="noopener noreferrer">EAAMO Bridges Website</a>
        </div>

      </section>
      
      {upcomingSpeakerViews.length > 0 && (
        <section id="upcoming-speakers">
          <h3 class="subsection-heading">Upcoming Talks & Speakers</h3>
          <div class="talks-list home-talks">
            {upcomingSpeakerViews.map((view: HomeSpeakerView) => (
              <ExpandableSpeakerCard entry={view.entry} displayTags={view.displayTags} />
            ))}
          </div>
        </section>
      )}

      <section id="speakers">
        <h3 class="subsection-heading">Recent Speakers & Activites</h3>
        <div class="talks-list home-talks">
          {homeSpeakerViews.map((view: HomeSpeakerView) => (
            <ExpandableSpeakerCard entry={view.entry} displayTags={view.displayTags} />
          ))}
        </div>
        <div class="all-posts-btn-wrapper">
          <LinkButton href="/events/">
            All Talks
            <svg xmlns="http://www.w3.org/2000/svg">
              <path d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"></path>
            </svg>
          </LinkButton>
        </div>
      </section>
    </div>
    <div class="right-col">
      <section id='selected-work'>
        <h2 class="main-section-heading">Projects</h2>
        
        <!-- Add a spacer div for extra vertical space -->
        <div class="section-spacer"></div>
        
        <!-- All projects section -->
        {sortedProjects.length > 0 && (
          <>
            <div class="projects-section-wrapper">
              <div class="projects-grid-container" id="projects-grid-container">
                <div class="projects-grid">
                  {sortedProjects.map((project: CollectionEntry<'projects'>) => (
                    <ProjectCard project={project} client:load />
                  ))}
                </div>
              </div>
              <div class="scroll-indicator" id="projects-scroll-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d="M9.29 6.71a.996.996 0 0 0 0 1.41L13.17 12l-3.88 3.88a.996.996 0 1 0 1.41 1.41l4.59-4.59a.996.996 0 0 0 0-1.41L10.7 6.7c-.38-.38-1.02-.38-1.41.01z"/>
                </svg>
              </div>
            </div>
          </>
        )}

        <!-- Members grid -->
        {sortedMembers.length > 0 && (
          <>
            <h3 class="subsection-heading mt-6">Organizers</h3>
            <div class="projects-section-wrapper">
              <div class="projects-grid-container" id="members-grid-container">
                <div class="projects-grid members-grid">
                  {sortedMembers.map((member: CollectionEntry<'members'>) => (
                    member.data.website ? (
                      <a class="member-card" href={member.data.website} target="_blank" rel="noopener noreferrer">
                        <div class="member-photo">
                          {member.data.image ? (
                            typeof member.data.image === 'string' ? (
                              <img 
                                src={member.data.image} 
                                alt={member.data.name} 
                                loading="lazy" 
                              />
                            ) : (
                              <img 
                                src={member.data.image.src} 
                                alt={member.data.name} 
                                width={member.data.image.width}
                                height={member.data.image.height}
                                loading="lazy" 
                              />
                            )
                          ) : (
                            <div class="member-photo-placeholder"></div>
                          )}
                        </div>
                        <div class="member-info">
                          <div class="member-name">{member.data.name}</div>
                          {member.data.affiliation && <div class="member-affiliation">{member.data.affiliation}</div>}
                        </div>
                      </a>
                    ) : (
                      <div class="member-card">
                        <div class="member-photo">
                          {member.data.image ? (
                            typeof member.data.image === 'string' ? (
                              <img 
                                src={member.data.image} 
                                alt={member.data.name} 
                                loading="lazy" 
                              />
                            ) : (
                              <img 
                                src={member.data.image.src} 
                                alt={member.data.name} 
                                width={member.data.image.width}
                                height={member.data.image.height}
                                loading="lazy" 
                              />
                            )
                          ) : (
                            <div class="member-photo-placeholder"></div>
                          )}
                        </div>
                        <div class="member-info">
                          <div class="member-name">{member.data.name}</div>
                          {member.data.affiliation && <div class="member-affiliation">{member.data.affiliation}</div>}
                        </div>
                      </div>
                    )
                  ))}
                </div>
              </div>
            </div>
          </>
        )}

        {readingItems.length > 0 && (
          <>
            <h3 class="subsection-heading mt-6">Reading List</h3>
            <ul class="reading-list">
              {readingItems.map((p: HomeReadingItem) => (
                <li class="reading-item">
                  <div class="reading-title">
                    {p.title}
                    {p.year && <span class="reading-venue"> Â· {p.year}</span>}
                  </div>
                  {p.venue && <div class="reading-desc">{p.venue}</div>}
                  <div class="reading-links">
                    <a class="underline" href={p.url} target="_blank" rel="noopener">Link</a>
                  </div>
                </li>
              ))}
            </ul>
            <div class="all-posts-btn-wrapper">
              <LinkButton href="/publications">
                All Reading
                <svg xmlns="http://www.w3.org/2000/svg">
                  <path d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"></path>
                </svg>
              </LinkButton>
            </div>
          </>
        )}
      </section>
    </div>
  </main>
  <Footer />

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const heroLogo = document.getElementById('hero-logo');
      const headerLogo = document.getElementById('header-logo');
      const logoLink = document.getElementById('logo-link');
      
      if (heroLogo && headerLogo && logoLink) {
        // Store original positions after DOM is fully loaded
        const heroLogoRect = heroLogo.getBoundingClientRect();
        const headerLogoRect = headerLogo.getBoundingClientRect();
        
        // Save original positions
        const heroTop = heroLogoRect.top;
        const heroLeft = heroLogoRect.left;
        const headerTop = headerLogoRect.top;
        const headerLeft = headerLogoRect.left;
        
        // Initial state
        if (window.scrollY === 0) {
          headerLogo.style.opacity = '0';
          heroLogo.style.opacity = '1';
        } else {
          headerLogo.style.opacity = '1';
          heroLogo.style.opacity = '0';
        }
        
        // Smooth scroll handling
        window.addEventListener('scroll', () => {
          const scrollY = window.scrollY;
          
          // Define the transition zone 
          const transitionStart = 0;
          const transitionEnd = 100; // shorter transition zone
          
          if (scrollY <= transitionStart) {
            // Before transition: hero logo visible, in original position
            heroLogo.style.position = 'relative';
            heroLogo.style.top = '0';
            heroLogo.style.left = '0';
            heroLogo.style.transform = 'none';
            heroLogo.style.opacity = '1';
            headerLogo.style.opacity = '0';
          } else if (scrollY > transitionStart && scrollY < transitionEnd) {
            // During transition: smoothly animate position and opacity
            const progress = (scrollY - transitionStart) / (transitionEnd - transitionStart);
            
            // Position heroLogo absolutely during transition
            heroLogo.style.position = 'fixed';
            heroLogo.style.top = `${headerTop}px`;
            
            // Calculate the left position difference and interpolate
            const leftDiff = headerLeft - heroLeft;
            heroLogo.style.left = `${heroLeft + (leftDiff * progress)}px`;
            
            // Scale down during transition
            const initialScale = 1;
            const targetScale = 0.8;
            heroLogo.style.transform = `scale(${initialScale - ((initialScale - targetScale) * progress)})`;
            
            // Crossfade between logos
            heroLogo.style.opacity = (1 - progress).toString();
            headerLogo.style.opacity = progress.toString();
          } else {
            // After transition: header logo fully visible
            heroLogo.style.opacity = '0';
            headerLogo.style.opacity = '1';
          }
        });
        
        // Recalculate on resize
        window.addEventListener('resize', () => {
          const newHeroRect = heroLogo.getBoundingClientRect();
          const newHeaderRect = headerLogo.getBoundingClientRect();
          
          // Update position values
          const heroTop = newHeroRect.top;
          const heroLeft = newHeroRect.left;
          const headerTop = newHeaderRect.top;
          const headerLeft = newHeaderRect.left;
        });
      }
    });

    // Scroll indicator functionality
    const initScrollIndicators = () => {
      const gridContainers = document.querySelectorAll('.projects-grid-container');
      
      gridContainers.forEach(container => {
        const grid = container.querySelector('.projects-grid');
        const wrapper = container.closest('.projects-section-wrapper');
        const indicator = wrapper ? wrapper.querySelector('.scroll-indicator') : null;
        
        if (!grid || !indicator || !wrapper) return;
        
        const checkScroll = () => {
          // Show indicator only if there's content to scroll to
          if (grid.scrollWidth > container.clientWidth) {
            // Check if we've scrolled to the end
            const isEnd = Math.ceil(container.scrollLeft + container.clientWidth) >= grid.scrollWidth;
            
            if (!isEnd) {
              indicator.classList.add('show');
            } else {
              indicator.classList.remove('show');
            }
          } else {
            indicator.classList.remove('show');
          }
        };
        
        // Setup indicator click action
        indicator.addEventListener('click', () => {
          container.scrollBy({ 
            left: 300, 
            behavior: 'smooth' 
          });
        });
        
        // Add scroll event listener
        container.addEventListener('scroll', checkScroll);
        
        // Check on load and resize
        checkScroll();
        window.addEventListener('resize', checkScroll);
        
        // Show indicator with a slight delay for better UX
        setTimeout(checkScroll, 500);
      });
    };
    
    // Initialize scroll indicators
    initScrollIndicators();

    // Debug helper function
    (window as any).debugReact = function(message: string) {
      console.log(`[Debug] ${message}`);
      const debugElement = document.getElementById('react-debug');
      if (debugElement) {
        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
        debugElement.innerHTML += `<div>${timeStr} - ${message}</div>`;
      }
    };
  </script>

</Layout>
